#!/bin/bash

module=$1
shift
version=$1
shift
moduledir=$1
shift
name="$*"

if test -z $module
then
  echo Please specify a module
  exit 1
fi

if test -z $version
then
  echo Please specify a version
  exit 1
fi

if test -z $moduledir
then
  echo Please specify a module dir
  exit 1
fi

if test -z "$name"
then
  echo Please specify a release name
  exit 1
fi

release=src/htdocs/releases/$module/$version
echo "Updating $release.xml"
cp src/htdocs/releases/$module/template.xml $release.xml
perl -i -p -e "s@<version></version>@<version>$version</version>@" $release.xml
perl -i -p -e "s@<name></name>@<name>$name</name>@" $release.xml
echo "Updating contributors"
changelog=$moduledir/ChangeLog
if test ! -e $changelog
then
  echo "No changelog $changelog found"
else
  bin/update-contributors $changelog $release.xml
fi
echo "Updating bugs"
bin/bugzilla $module $version GStreamer $release.xml

# update releases Makefile.am
makefileam=src/htdocs/releases/$module/Makefile.am
if grep $version $makefileam > /dev/null 2>&1
then
  echo already changed $makefileam
else
  echo Updating $makefileam
  perl -i.bak -p -e "s@(releases =)@\$1 $version@" $makefileam
fi

# update configure.ac
configureac=$moduledir/configure.ac
echo "Please update configure.ac's version number and libtool versioning."
read
$EDITOR $configureac

# update Changelog
changelog=$moduledir/ChangeLog
if grep "=== release $version ===" $changelog > /dev/null 2>&1
then
  echo already changed $changelog
else
  echo Updating $changelog
  mv $changelog $changelog.bak
  echo "=== release $version ===" > $changelog
  echo >> $changelog
  echo "`date +%Y-%m-%d`  $REAL_NAME <$EMAIL_ADDRESS>" >> $changelog
  echo >> $changelog
  echo -e "\t* configure.ac:" >> $changelog
  echo -e "\t  releasing $version, \"$name\"" >> $changelog
  echo >> $changelog
  cat $changelog.bak >> $changelog
fi

# FIXME: add to cvs
cvs add $release.xml

echo "Now press Enter to edit the next .xml file and update the list of features and API changes"
read

$EDITOR $release.xml

echo "Building website"
make

release=htdocs/releases/$module/$version
echo "Copying RELEASE"
cp $release $moduledir/RELEASE

echo "Please update NEWS with information from RELEASE"
read
$EDITOR $moduledir/NEWS $release

pushdir
cd $moduledir
make release
popdir
mv $moduledir/$module-$version.tar.* data/src/$module
