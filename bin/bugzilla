#!/usr/bin/env python
# -*- Mode: Python -*-

# parse HTML from bugzilla.gnome.org to create a list of bugs for a given
# product, component and target_milestone

import re
import sys
import urllib
import HTMLParser

# a sample bug line we parse for future reference:
#<TR VALIGN=TOP ALIGN=LEFT CLASS="Nor" ><TD><A HREF="show_bug.cgi?id=78267">78267</A> <td class=severity><nobr>min</nobr></td><td class=priority><nobr>Nor</nobr></td><td class=owner><nobr>thomas@apestaart.org</nobr></td><td class=status><nobr>RESO</nobr></td><td class=resolution><nobr>FIXE</nobr></td><td class=summary>autogen.sh doesn't take --prefix and similar to configure</td></TR>

URL = 'http://bugzilla.gnome.org/buglist.cgi?product=%s&component=%s&target_milestone=%s'

# reg = re.compile('<TR.*id=(\d+)".*summary>(.*)<\/td')

HEADER = '  <bugs>'
ITEM = """    <bug>
      <id>%s</id>
      <summary>%s</summary>
    </bug>"""
FOOTER = '  </bugs>'

components = {
  'gstreamer': 'gstreamer (core)' 
}

default_product = "GStreamer"

TD_ID = 1
TD_SUMMARY = 7

# Horrible, don't look here
class HP(HTMLParser.HTMLParser):
    def __init__(self):
        HTMLParser.HTMLParser.__init__(self)
        self.tr = 0
        self.td = 0
        self.bugs = []
        self.bugno = 0
        self.descr = ""

    def handle_starttag(self, tag, data):
        if tag == 'tr':
            self.tr = 1
            return
        # count td's
        elif self.tr and tag == 'td':
            self.td += 1

    # all &gt; refs are handled through this method; append them to self.descr
    def handle_entityref(self, name):
        self.descr += " &%s; " % name

    # can be called more than once for one td
    def handle_data(self, data):
        if not self.tr:
            return
        data = data.strip()
        if not data:
            return
        
	#print self.td, self.tr, repr(data)

	# clear self.descr if we're not in the correct td
	if self.td != TD_SUMMARY:
	    self.descr = ""

        # check what td it is in
        if self.td == TD_ID:
            try:
                self.bugno = int(data)
            except ValueError:
                self.bugno = 0
        elif self.td == TD_SUMMARY:
            # the summary td
            self.descr += data
        
    def handle_endtag(self, tag):
        if tag == 'tr':
            self.tr = 0
            self.td = 0
            if self.bugno != 0:
                self.bugs.append((self.bugno, self.descr))
                self.bugno = 0

def main(args):
    if len(args) < 3:
        print 'Usage: %s component milestone [product]' % args[0]
        return 2

    # translate the component if it's in our dict of components
    if args[1] in components.keys():
        component = components[args[1]]
    else:
        component = args[1]
    milestone = args[2]

    if len(args) == 3:
        product = default_product
    else:
        product = args[3]

    url = URL % (product, urllib.quote(component), milestone)
    fd = urllib.urlopen(url)
    
    hp = HP()
    hp.feed(fd.read())
    
    print HEADER
    for bug_id, summary in hp.bugs:
        print ITEM % (bug_id, summary)
    print FOOTER

        
if __name__ == '__main__':
    sys.exit(main(sys.argv))
